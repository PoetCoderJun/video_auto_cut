# 自动口播剪辑 + PPT 画面生成（计划书）

日期：2026-02-04

## 1. 目标与范围
- **目标**：实现“自动剪辑 + 人工可编辑 + 口播视频导出”的一体化网页工具（MVP 阶段无 PPT，但采用 Remotion 统一渲染）。
- **输入**：一段口播视频。
- **输出**：
  - 已剪辑视频（去水词/口误/重复）
  - 字幕（SRT/ASS）
  - （MVP 不包含）PPT 主画面 + 口播小窗
- **核心原则**：自动决策为默认，所有剪辑可在网页中人工确认和微调。

## 1.1 用户最初需求（原始请求整理）
1) **ASR + 时间戳字幕**：识别字幕并带时间戳，可参考/复用 AutoCut 的实现方式。  
2) **自动删水词/口误/重复**：由大模型接管（API），输出可编辑的删改建议。  
3) **自动加字幕**：在剪辑后的视频中烧录字幕（或输出软字幕）。  
4) **PPT 画面增强**：根据字幕文案生成 PPT 风格主画面，口播小窗在右下角，并在合适时间嵌入图片与页面切换。

## 2. 核心概念与分层
### 2.1 微分段（ASR Segments）
- 切分依据：气口/停顿（短句）。
- 作用：精细时间戳、删除/保留粒度。

### 2.2 语义段（Semantic Segments / PPT Pages）
- 切分依据：语义主题（多个 ASR 片段合并）。
- 作用：PPT 页面级的结构；一个视频可能只对应 4–10 页 PPT。

### 2.3 画面布局（Layout）
- `ppt_main`：PPT 为主，口播小窗右下角。
- `talking_head_main`：口播为主，PPT 辅（可选择是否展示）。
- 布局切换按语义段为主，允许在语义段内部切 1 次。

## 3. 系统架构（高层）
- 前端：React 工作台（上传、时间线、编辑、预览）。
- 后端：Python API 服务（ASR、LLM、渲染编排）。
- 渲染层：Remotion（Node.js 运行渲染任务，Python 调用）
- 异步任务：MVP 先不引入任务队列，使用简化后台任务（或同步接口）；后续可切换到 RQ/Celery。
- 存储：本地文件 + 元数据（后续可扩展对象存储）。

## 3.1 AutoCut 参考与整体设计思路
### 3.1.1 AutoCut 的可复用思路
- **字幕驱动剪辑**：基于 ASR 的时间戳字幕生成可裁剪片段（EDL），再由 FFmpeg 拼接。
- **人工可编辑**：选择/删除字幕片段即是剪辑决策（可直接映射到时间段）。
- **参考项目**：AutoCut 开源实现（链接如下）。  
  https://github.com/mli/autocut

### 3.1.2 在本项目中的增强
- **自动建议 + 人工确认**：LLM 给出删除/保留建议，前端允许逐段确认/撤回。
- **双层分段**：ASR 微分段用于精剪；语义段用于 PPT 页级控制（MVP 暂不启用）。
- **画面布局决策**：对语义段标注 `ppt_main` / `talking_head_main`（MVP 暂不启用）。

### 3.1.3 核心流程（端到端）
1) 上传视频  
2) ASR 转写 → 微分段字幕  
3) LLM 剪辑建议 → 删除/保留/理由  
4) LLM 语义段聚合 → PPT 页级结构（MVP 暂不启用）  
5) 前端人工确认/微调  
6) 渲染：Remotion 统一渲染（字幕 + 画中画预留，MVP 不含 PPT）  

## 4. 技术栈（关键部分）
### 4.1 前端（Web）
- **框架**：React 18
- **构建工具**：Vite
- **播放器**：原生 HTML5 video + Canvas 预览层
- **时间线**：自研（简单版）或引入轻量时间轴组件
- **状态管理**：Zustand（轻量、易维护）
- **样式**：CSS Modules 或 Tailwind（待定）

### 4.2 后端（API）
- **语言**：Python 3.11+
- **框架**：FastAPI
- **异步任务**：MVP 不引入任务队列（后续可选 RQ/Celery）
- **数据存储**：
  - 初期：SQLite + 文件系统
  - 扩展：PostgreSQL + 对象存储（S3 兼容）

### 4.3 ASR 转写
- **调用方式**：DashScope（Qwen）云端 ASR API（MVP）
- **输出格式**：词级/短句级时间戳
- **预处理**：静音检测（可选，用于切分微分段）

### 4.3.1 AutoCut 相关依赖（参考/复用）
- **AutoCut 项目**：字幕驱动剪辑的参考实现（用于理解流程与剪辑思路）。
- **FFmpeg**：AutoCut 的核心依赖；本项目由 Remotion 底层调用。
- **Python 依赖**：后续若直接复用 AutoCut 部分代码，需要对应的 Python 包与环境（以实际取用模块为准）。
- **注意**：本项目不直接锁死 AutoCut 的具体实现细节，优先复用其“字幕 → 片段 → 剪辑”的思路与 EDL 结构。

### 4.4 LLM 决策
- **模型**：DashScope（Qwen 最新模型，MVP）
- **任务 1**：剪辑建议（删除/保留 + 理由）
- **任务 2**：语义段聚合 + PPT 结构建议
- **输出格式**：结构化 JSON，严格校验

### 4.5 渲染与导出
- **视频剪辑**：Remotion 统一渲染（基于 EDL 时间线）
- **字幕渲染**：Remotion 文本层（可控样式/动画）
- **PPT 画面**：Remotion（MVP 暂不启用）
  - 需要 Node.js 运行渲染任务
  - Python 通过子进程调用 Remotion
- **画中画合成**：Remotion 画中画层（PPT 阶段启用）
- **FFmpeg**：由 Remotion 底层调用（必要时用于预处理/转码）

### 4.5.1 Remotion 剪辑渲染（MVP 最小实现方案）
- **输入**：EDL 片段列表（start/end），ASR 字幕（含时间戳），渲染参数（分辨率/帧率）。
- **时间线策略**：把保留片段依次拼接成一条新时间线；每个片段在 Remotion 中以 `<Sequence>` 表达。
- **视频拼接**：
  - 方案 A（简单）：每个片段一个 `<Sequence>` + `<Video startFrom=... endAt=...>`。
  - 方案 B（性能）：预先裁剪为若干中间文件，再用 Remotion 播放中间文件（减少随机 seek）。
- **字幕叠加**：
  - 将字幕时间戳映射到“新时间线”（片段前缀累计时长）。
  - 使用统一 `Subtitle` 组件渲染，避免样式分散。
- **输出**：Remotion render 输出最终视频；需要时再用 FFmpeg 做封装/转码。

### 4.5.2 字幕样式（主题化参数）
- `subtitle_theme`: { font_family, font_size, font_weight, line_height, color, stroke_color, stroke_width, shadow_color, shadow_blur, bg_color, bg_padding, max_lines, safe_margin, align, animation }
- **默认策略**：单行或双行、描边 + 阴影、下方安全区 8–10%，避免遮挡脸部。
- **可扩展**：逐词高亮、轻微入场动画、关键词高亮。

### 4.6 Remotion 的优势（为什么用）
- **统一技术栈**：PPT 画面可以直接用 React/CSS 写，设计迭代快。
- **帧级可控**：动画、切换、时序精确到帧，和语义段对齐容易。
- **模板化方便**：支持主题/模板复用，后续可做多风格模板库。
- **动态内容友好**：标题、要点、图片、配色都能按 LLM 输出动态生成。
- **可测试性强**：组件化结构便于自动化测试和回归检查。

## 5. PPT 生成的思路与技术栈（MVP 之后）
### 5.1 语义到页面的生成链路
- **输入**：语义段（summary、bullets、关键词、图片提示）。
- **输出**：PPT 页结构化定义（标题/要点/配图/主题/版式/时长）。
- **流程**：
  1) 语义段聚合（LLM）→ 语义段列表（含摘要与要点）
  2) 页级规划（LLM）→ 每页标题、要点、配图提示、推荐布局
  3) 资产获取（可选）→ 图片检索/占位图/素材库
  4) 版式渲染（Remotion）→ 视频化的 PPT 片段
  5) 与口播合成 → 画中画/主画面切换

### 5.2 PPT 页面数据结构（示意）
- `slides[]`: { id, start, end, title, bullets[], image_prompt, layout, theme_id }

### 5.3 技术栈选择
- **页面渲染**：Remotion（React 组件化模板）
- **版式模板**：3–5 种基础模板（标题页/要点页/对比页/大图页）
- **图片来源**：
  - 初期：占位图或人工上传
  - 扩展：图像检索 API 或素材库（可替换）
- **主题系统**：颜色/字体/间距/动效统一配置

### 5.4 人工可控点
- 页数可手动增减
- 每页标题/要点可编辑
- 图片可手动替换/禁用
- 布局可切换（PPT 主 / 口播主）

### 5.5 风险与对策
- **内容密度不均**：提供“压缩/扩展”按钮对页数微调
- **图片质量参差**：先支持手工上传，自动检索做辅助
- **风格不统一**：模板化 + 主题系统约束

## 6. 数据结构（示意）
### 5.1 ASR 输出
- `asr_segments[]`: { id, start, end, text, confidence }

### 5.2 语义段输出
- `semantic_segments[]`: { id, start, end, summary, bullets[], image_prompt }

### 5.3 编辑决策
- `edit_decisions[]`: { segment_id, decision, start, end, reason }
- `layout_decisions[]`: { semantic_id, layout, slide_assets[] }

## 7. 前端交互设计（MVP）
- 上传区：上传视频，显示进度
- 时间线：ASR 片段列表（删除/恢复/微调）
- 语义段面板：MVP 暂不启用（后续用于 PPT 页管理）
- 预览区：当前片段视频预览
- 导出按钮：生成最终视频

## 8. 后端接口（MVP）
- `POST /upload`
- `POST /asr`
- `POST /llm/edit-suggest`
- `POST /render`
- `GET /task/{id}`

## 9. 实施里程碑
1) **基础骨架**：前后端脚手架 + 数据模型定义
2) **ASR + 剪辑建议**：接入 DashScope（Qwen）
3) **前端编辑工作台**：时间线 + 片段删除/恢复/微调
4) **渲染链路**：Remotion 统一渲染（字幕 + 时间线）
5) **PPT 生成**：Remotion 模板化页面（MVP 之后）
6) **联调与优化**：性能、稳定性、提示词调优

## 9.1 MVP 拆解（3–4 步）
1) **可上传 + 可转写**：上传视频 → 调用 ASR → 生成 `asr_segments`
2) **可自动剪辑建议**：LLM 生成删改建议 → 前端可确认/撤回
3) **可预览 + 可编辑**：前端时间线列表 + 视频预览 + 片段微调
4) **可导出成片**：EDL → Remotion 渲染 → 输出最终视频

## 9.2 MVP 架构设计（Remotion 统一渲染）
- **前端（Web）**
  - 上传/进度/预览/时间线编辑
  - 产出：编辑后的 `edit_decisions` + 导出参数
- **后端（FastAPI）**
  - 接口层：`/upload` `/asr` `/llm/edit-suggest` `/render`
  - 编排层：ASR/LLM/渲染任务的状态机
  - 产出：EDL、字幕、渲染任务
- **渲染层（Remotion + Node）**
  - 输入：EDL + 字幕 + 渲染参数
  - 输出：`output.mp4`
- **存储层**
  - SQLite：项目/片段/决策/任务状态
  - 文件系统：源视频、ASR JSON、EDL JSON、输出视频

## 10. 风险与对策
- **LLM 误删**：所有删改必须可撤回；提供保守/激进开关
- **语义段过多/过少**：允许人工调整合并/拆分
- **渲染耗时**：后台任务 + 进度回传（后续可上任务队列）
- **PPT 质量**：初期自动生成，后期支持模板/手工替换

## 11. 下一步需要确认
- 已确认：先做“无 PPT 版本”的 MVP
- 已确认：MVP 阶段不做任务队列
- 已确认：ASR/LLM 使用 DashScope（Qwen 最新模型）
- 已确认：视频剪辑采用 Remotion 统一渲染（字幕样式由 Remotion 控制）
- 前端样式偏好（简约/品牌化）
